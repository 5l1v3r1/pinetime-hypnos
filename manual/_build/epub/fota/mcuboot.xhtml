<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Wireless Device Firmware Upgrade</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="wireless-device-firmware-upgrade">
<span id="mcuboot"></span><h1>Wireless Device Firmware Upgrade</h1>
<div class="section" id="overview">
<h2>Overview</h2>
<p>In order to perform a FOTA (firmware over the air) update on zephyr you need 2 basic components:</p>
<blockquote>
<div><ul class="simple">
<li><p>MCUboot   (a bootloader)</p></li>
<li><p>SMP Server Sample (a bluetooth service)</p></li>
</ul>
</div></blockquote>
<div class="section" id="id1">
<span id="id2"></span><h3>MCUboot</h3>
</div>
</div>
</div>
<div class="section" id="mcuboot-with-zephyr">
<h1>MCUboot with zephyr</h1>
<p>The first step required for Zephyr is making sure your board has flash
partitions defined in its device tree. These partitions are:</p>
<ul class="simple">
<li><p><cite>boot_partition</cite>: for MCUboot itself</p></li>
<li><p><cite>image_0_primary_partition</cite>: the primary slot of Image 0</p></li>
<li><p><cite>image_0_secondary_partition</cite>: the secondary slot of Image 0</p></li>
<li><p><cite>scratch_partition</cite>: the scratch slot</p></li>
</ul>
<p>The flash partitions are defined in the pinetime boards folder, in a
file named <cite>boards/arm/pinetime/pinetime.dts</cite>.</p>
<p>Install additional packages required for development with mcuboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">mcuboot</span>  <span class="c1"># or to your directory where mcuboot is cloned</span>
<span class="n">pip3</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">-</span><span class="n">r</span> <span class="n">scripts</span><span class="o">/</span><span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>To build MCUboot, create a build directory in boot/zephyr, and build
it as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">boot</span><span class="o">/</span><span class="n">zephyr</span>
<span class="n">mkdir</span> <span class="n">build</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">build</span>
<span class="n">cmake</span> <span class="o">-</span><span class="n">GNinja</span> <span class="o">-</span><span class="n">DBOARD</span><span class="o">=</span><span class="n">pinetime</span> <span class="o">..</span>
<span class="n">ninja</span>
</pre></div>
</div>
<p>After building the bootloader, the binaries should reside in
<cite>build/zephyr/zephyr.{bin,hex,elf}</cite>.</p>
<p>This image can be flashed as a normal application.</p>
<p>Some additional configuration is required to build applications for MCUboot.</p>
<p>This is handled internally by the Zephyr configuration system and is wrapped
in the <cite>CONFIG_BOOTLOADER_MCUBOOT</cite> Kconfig variable, which must be enabled in
the applicationâ€™s <cite>prj.conf</cite> file.</p>
<p>The Zephyr <cite>CONFIG_BOOTLOADER_MCUBOOT</cite> configuration option
[documentation](<a class="reference external" href="http://docs.zephyrproject.org/reference/kconfig/CONFIG_BOOTLOADER_MCUBOOT.html">http://docs.zephyrproject.org/reference/kconfig/CONFIG_BOOTLOADER_MCUBOOT.html</a>)
provides additional details regarding the changes it makes to the image
placement and generation in order for an application to be bootable by
MCUboot.</p>
<p>In order to upgrade to an image (or even boot it, if
<cite>MCUBOOT_VALIDATE_PRIMARY_SLOT</cite> is enabled), the images must be signed.</p>
<p>To make development easier, MCUboot is distributed with some example
keys.  It is important to stress that these should never be used for
production, since the private key is publicly available in this
repository.  See below on how to make your own signatures.</p>
<p>Images can be signed with the <cite>scripts/imgtool.py</cite> script.  It is best
to look at <cite>samples/zephyr/Makefile</cite> for examples on how to use this.</p>
<p>Since the bootloader is already in place, you cannot flash your application.bin to 0x00000.</p>
<p>Eg. in openocd : program application.bin 0x0c000. (which corresponds to the flash layout of slot 0)</p>
<p>These images can also be marked for upgrade, and loaded into the secondary slot,
at which point the bootloader should perform an upgrade.</p>
<p>Generating a keypair with imgtool is a matter of running the keygen
subcommand:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./scripts/imgtool.py keygen -k mykey.pem -t rsa-2048
</pre></div>
</div>
<p>The generated keypair above contains both the public and the private
key.  It is necessary to extract the public key and insert it into the
bootloader.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./scripts/imgtool.py getpub -k mykey.pem
</pre></div>
</div>
<p>This will output the public key as a C array that can be dropped
directly into the <cite>keys.c</cite> file.</p>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>